<div class="users-container">
  <div class="page-header">
    <h1>Gestión de Usuarios</h1>
    <p>Administra todos los usuarios del sistema</p>
  </div>

  <div class="content-card">
    <!-- Loading State -->
    <div *ngIf="isLoading()" class="loading-state">
      <div class="loading-spinner"></div>
      <p>Cargando usuarios...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="errorMessage()" class="error-state">
      <div class="error-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="15" y1="9" x2="9" y2="15"/>
          <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
      </div>
      <h3>Error al cargar usuarios</h3>
      <p>{{ errorMessage() }}</p>
      <button class="btn btn-primary" (click)="loadUsers()">Reintentar</button>
    </div>

    <!-- Users List -->
    <div *ngIf="!isLoading() && !errorMessage()" class="users-content">
      <div class="users-header">
        <div class="users-count">
          <span class="count-number">{{ users().length }}</span>
          <span class="count-label">usuarios registrados</span>
        </div>
        <button class="btn btn-primary" (click)="openCreateModal()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="5" x2="12" y2="19"/>
            <line x1="5" y1="12" x2="19" y2="12"/>
          </svg>
          Nuevo Usuario
        </button>
      </div>

      <div class="users-table-container">
        <table class="users-table">
          <thead>
            <tr>
              <th>
                <input
                  type="checkbox"
                  [checked]="allSelected()"
                  (change)="toggleSelectAll($event)"
                />
              </th>
              <th>Usuario</th>
              <th>Email</th>
              <th>Roles</th>
              <th>Fecha de Registro</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of users()" class="user-row">
              <td>
                <input
                  type="checkbox"
                  [checked]="isSelected(user)"
                  (change)="toggleUserSelection(user)"
                />
              </td>
              <td class="user-info">
                <div class="user-avatar">
                  {{ user.name.charAt(0).toUpperCase() }}
                </div>
                <div class="user-details">
                  <div class="user-name">{{ user.name }}</div>
                </div>
              </td>
              <td class="user-email">{{ user.email }}</td>
              <td class="user-roles">{{ getUserRoles(user) }}</td>
              <td class="created-date">{{ formatDate(user.created_at) }}</td>
              <td class="actions">
                <button class="btn btn-sm btn-outline" (click)="openEditModal(user)">Editar</button>
                <button class="btn btn-sm btn-danger" (click)="openDeleteModal(user)">Eliminar</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Botón para eliminar seleccionados -->
      <div *ngIf="selectedUsers().length >= 2" class="bulk-actions">
        <button class="btn btn-danger" (click)="deleteSelectedUsers()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
          Eliminar seleccionados ({{ selectedUsers().length }})
        </button>
      </div>

      <!-- Empty State -->
      <div *ngIf="users().length === 0" class="empty-state">
        <div class="empty-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
        </div>
        <h3>No hay usuarios registrados</h3>
        <p>Comienza creando el primer usuario del sistema</p>
        <button class="btn btn-primary" (click)="openCreateModal()">Crear Usuario</button>
      </div>
    </div>
  </div>
</div>

<!-- Success Message -->
<div *ngIf="successMessage()" class="success-message">
  {{ successMessage() }}
</div>

<!-- Create User Modal -->
<div *ngIf="showCreateModal()" class="modal-overlay" (click)="closeModals()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Crear Nuevo Usuario</h3>
      <button class="modal-close" (click)="closeModals()">&times;</button>
    </div>

    <form [formGroup]="userForm" (ngSubmit)="createUser()" class="modal-form">
      <div class="form-group">
        <label for="create-name">Nombre Completo</label>
        <input
          type="text"
          id="create-name"
          formControlName="name"
          class="form-control"
          [class.error]="getFieldError('name')"
          placeholder="Nombre completo"
        />
        <div class="error-message" *ngIf="getFieldError('name')">
          {{ getFieldError('name') }}
        </div>
      </div>

      <div class="form-group">
        <label for="create-email">Correo Electrónico</label>
        <input
          type="email"
          id="create-email"
          formControlName="email"
          class="form-control"
          [class.error]="getFieldError('email')"
          placeholder="usuario@email.com"
        />
        <div class="error-message" *ngIf="getFieldError('email')">
          {{ getFieldError('email') }}
        </div>
      </div>

      <div class="form-group">
        <label for="fecha_nacimiento">Fecha de Nacimiento</label>
        <input
          type="date"
          id="fecha_nacimiento"
          formControlName="fecha_nacimiento"
          class="form-control"
          [class.error]="getFieldError('fecha_nacimiento')"
        />
        <div class="error-message" *ngIf="getFieldError('fecha_nacimiento')">
          {{ getFieldError('fecha_nacimiento') }}
        </div>
      </div>

      <div class="form-group">
        <label for="pais">País</label>
        <select
          id="pais"
          formControlName="pais"
          class="form-control"
          [class.error]="getFieldError('pais')"
        >
          <option value="">Seleccione país</option>
          <option value="Argentina">Argentina</option>
          <option value="Bolivia">Bolivia</option>
          <option value="Brasil">Brasil</option>
          <option value="Chile">Chile</option>
          <option value="Colombia">Colombia</option>
          <option value="Ecuador">Ecuador</option>
          <option value="Paraguay">Paraguay</option>
          <option value="Perú">Perú</option>
          <option value="Uruguay">Uruguay</option>
          <option value="Venezuela">Venezuela</option>
        </select>
        <div class="error-message" *ngIf="getFieldError('pais')">
          {{ getFieldError('pais') }}
        </div>
      </div>

      <div class="form-group">
        <label for="genero">Género</label>
        <select
          id="genero"
          formControlName="genero"
          class="form-control"
          [class.error]="getFieldError('genero')"
        >
          <option value="">Seleccionar género</option>
          <option value="Masculino">Masculino</option>
          <option value="Femenino">Femenino</option>
          <option value="Otro">Otro</option>
        </select>
        <div class="error-message" *ngIf="getFieldError('genero')">
          {{ getFieldError('genero') }}
        </div>
      </div>

      <div class="form-group">
        <label for="telefono">Teléfono</label>
        <input
          type="text"
          id="telefono"
          formControlName="telefono"
          class="form-control"
          [class.error]="getFieldError('telefono')"
          placeholder="Número de teléfono"
        />
        <div class="error-message" *ngIf="getFieldError('telefono')">
          {{ getFieldError('telefono') }}
        </div>
      </div>

      <div class="form-group">
        <label for="activo">Estado de la cuenta</label>
        <div class="checkbox-single">
          <input
            type="checkbox"
            id="activo"
            formControlName="activo"
          />
          <label for="activo">Cuenta activa</label>
        </div>
      </div>

      <div class="form-group">
        <label for="create-role">Rol <span class="required">*</span></label>
        <select
          id="create-role"
          formControlName="role"
          class="form-control"
          [class.error]="getFieldError('role')"
        >
          <option value="">Seleccionar rol</option>
          <option *ngFor="let role of availableRoles()" [value]="role.name">
            {{ role.name }}
          </option>
        </select>
        <div class="error-message" *ngIf="getFieldError('role')">
          {{ getFieldError('role') }}
        </div>
      </div>

      <div class="form-group">
        <label for="password">Contraseña <span class="required">*</span></label>
        <input
          type="password"
          id="password"
          formControlName="password"
          class="form-control"
          [class.error]="getFieldError('password')"
          placeholder="Mínimo 8 caracteres"
        />
        <div class="error-message" *ngIf="getFieldError('password')">
          {{ getFieldError('password') }}
        </div>
      </div>

      <div class="form-group">
        <label for="password_confirmation">Confirmar Contraseña <span class="required">*</span></label>
        <input
          type="password"
          id="password_confirmation"
          formControlName="password_confirmation"
          class="form-control"
          [class.error]="getFieldError('password_confirmation')"
          placeholder="Repite la contraseña"
        />
        <div class="error-message" *ngIf="getFieldError('password_confirmation')">
          {{ getFieldError('password_confirmation') }}
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-outline" (click)="closeModals()">Cancelar</button>
        <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid || isLoading()">
          {{ isLoading() ? 'Creando...' : 'Crear Usuario' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Edit User Modal -->
<div *ngIf="showEditModal()" class="modal-overlay" (click)="closeModals()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Editar Usuario: {{ selectedUser()?.name }}</h3>
      <button class="modal-close" (click)="closeModals()">&times;</button>
    </div>

    <form [formGroup]="userForm" (ngSubmit)="updateUser()" class="modal-form">
      <div class="form-group">
        <label for="edit-name">Nombre Completo</label>
        <input
          type="text"
          id="edit-name"
          formControlName="name"
          class="form-control"
          [class.error]="getFieldError('name')"
          placeholder="Nombre completo"
        />
        <div class="error-message" *ngIf="getFieldError('name')">
          {{ getFieldError('name') }}
        </div>
      </div>

      <div class="form-group">
        <label for="edit-email">Correo Electrónico</label>
        <input
          type="email"
          id="edit-email"
          formControlName="email"
          class="form-control"
          [class.error]="getFieldError('email')"
          placeholder="usuario@email.com"
        />
        <div class="error-message" *ngIf="getFieldError('email')">
          {{ getFieldError('email') }}
        </div>
      </div>

      <div class="form-group">
        <label for="edit-fecha_nacimiento">Fecha de Nacimiento</label>
        <input
          type="date"
          id="edit-fecha_nacimiento"
          formControlName="fecha_nacimiento"
          class="form-control"
          [class.error]="getFieldError('fecha_nacimiento')"
        />
        <div class="error-message" *ngIf="getFieldError('fecha_nacimiento')">
          {{ getFieldError('fecha_nacimiento') }}
        </div>
      </div>

      <div class="form-group">
        <label for="edit-pais">País</label>
        <select
          id="edit-pais"
          formControlName="pais"
          class="form-control"
          [class.error]="getFieldError('pais')"
        >
          <option value="">Seleccione país</option>
          <option value="Argentina">Argentina</option>
          <option value="Bolivia">Bolivia</option>
          <option value="Brasil">Brasil</option>
          <option value="Chile">Chile</option>
          <option value="Colombia">Colombia</option>
          <option value="Ecuador">Ecuador</option>
          <option value="Paraguay">Paraguay</option>
          <option value="Perú">Perú</option>
          <option value="Uruguay">Uruguay</option>
          <option value="Venezuela">Venezuela</option>
        </select>
        <div class="error-message" *ngIf="getFieldError('pais')">
          {{ getFieldError('pais') }}
        </div>
      </div>

      <div class="form-group">
        <label for="edit-genero">Género</label>
        <select
          id="edit-genero"
          formControlName="genero"
          class="form-control"
          [class.error]="getFieldError('genero')"
        >
          <option value="">Seleccionar género</option>
          <option value="Masculino">Masculino</option>
          <option value="Femenino">Femenino</option>
          <option value="Otro">Otro</option>
        </select>
        <div class="error-message" *ngIf="getFieldError('genero')">
          {{ getFieldError('genero') }}
        </div>
      </div>

      <div class="form-group">
        <label for="edit-telefono">Teléfono</label>
        <input
          type="text"
          id="edit-telefono"
          formControlName="telefono"
          class="form-control"
          [class.error]="getFieldError('telefono')"
          placeholder="Número de teléfono"
        />
        <div class="error-message" *ngIf="getFieldError('telefono')">
          {{ getFieldError('telefono') }}
        </div>
      </div>

      <div class="form-group">
        <label for="edit-activo">Estado de la cuenta</label>
        <div class="checkbox-single">
          <input
            type="checkbox"
            id="edit-activo"
            formControlName="activo"
          />
          <label for="edit-activo">Cuenta activa</label>
        </div>
      </div>

      <div class="form-group">
        <label for="edit-role">Rol <span class="required">*</span></label>
        <select
          id="edit-role"
          formControlName="role"
          class="form-control"
          [class.error]="getFieldError('role')"
        >
          <option value="">Seleccionar rol</option>
          <option *ngFor="let role of availableRoles()" [value]="role.name">
            {{ role.name }}
          </option>
        </select>
        <div class="error-message" *ngIf="getFieldError('role')">
          {{ getFieldError('role') }}
        </div>
      </div>

      <div class="form-group">
        <label for="edit-password">Nueva Contraseña (opcional)</label>
        <input
          type="password"
          id="edit-password"
          formControlName="password"
          class="form-control"
          [class.error]="getFieldError('password')"
          placeholder="Dejar vacío para mantener la actual"
        />
        <div class="error-message" *ngIf="getFieldError('password')">
          {{ getFieldError('password') }}
        </div>
      </div>

      <div class="form-group">
        <label for="edit-password_confirmation">Confirmar Nueva Contraseña</label>
        <input
          type="password"
          id="edit-password_confirmation"
          formControlName="password_confirmation"
          class="form-control"
          [class.error]="getFieldError('password_confirmation')"
          placeholder="Repite la nueva contraseña"
        />
        <div class="error-message" *ngIf="getFieldError('password_confirmation')">
          {{ getFieldError('password_confirmation') }}
        </div>
      </div>


      <div class="modal-actions">
        <button type="button" class="btn btn-outline" (click)="closeModals()">Cancelar</button>
        <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid || isLoading()">
          {{ isLoading() ? 'Actualizando...' : 'Actualizar Usuario' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Delete User Modal -->
<div *ngIf="showDeleteModal()" class="modal-overlay" (click)="closeModals()">
  <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Eliminar Usuario</h3>
      <button class="modal-close" (click)="closeModals()">&times;</button>
    </div>

    <div class="modal-body">
      <div class="warning-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
      </div>
      <p>¿Estás seguro de que quieres eliminar al usuario <strong>{{ selectedUser()?.name }}</strong>?</p>
      <p class="warning-text">Esta acción no se puede deshacer.</p>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn btn-outline" (click)="closeModals()">Cancelar</button>
      <button type="button" class="btn btn-danger" (click)="deleteUser()" [disabled]="isLoading()">
        {{ isLoading() ? 'Eliminando...' : 'Eliminar Usuario' }}
      </button>
    </div>
  </div>
</div>
<!-- Delete User Modal -->
<div *ngIf="showDeleteModal()" class="modal-overlay" (click)="closeModals()">
  <div class="modal-content delete-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Eliminar Usuario</h3>
      <button class="modal-close" (click)="closeModals()">&times;</button>
    </div>

    <div class="modal-body">
      <div class="warning-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
      </div>
      <p>¿Estás seguro de que quieres eliminar al usuario <strong>{{ selectedUser()?.name }}</strong>?</p>
      <p class="warning-text">Esta acción no se puede deshacer.</p>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn btn-outline" (click)="closeModals()">Cancelar</button>
      <button type="button" class="btn btn-danger" (click)="deleteUser()" [disabled]="isLoading()">
        {{ isLoading() ? 'Eliminando...' : 'Eliminar Usuario' }}
      </button>
    </div>
  </div>
</div>
